<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>C++ interconnectivity via Rcpp | Advanced Programming in R</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.4.0">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../chapters/05_final_remarks/FINAL_REMARKS.html" />
    
    
    <link rel="prev" href="../../chapters/04_speed_up/parallelization.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="4.2" data-basepath="../.." data-revision="Wed Oct 07 2015 16:38:53 GMT+0200 (CEST)">
    

<div class="book-summary">
    <div class="book-search" role="search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="chapters/01_structured_workflow/STRUCTURED_WORKFLOW.html">
            
                
                    <a href="../../chapters/01_structured_workflow/STRUCTURED_WORKFLOW.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Towards a structured workflow
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="chapters/01_structured_workflow/projects.html">
            
                
                    <a href="../../chapters/01_structured_workflow/projects.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        RStudio projects
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="chapters/01_structured_workflow/version_control.html">
            
                
                    <a href="../../chapters/01_structured_workflow/version_control.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        GitHub version control
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="chapters/02_data_handling/DATA_HANDLING.html">
            
                
                    <a href="../../chapters/02_data_handling/DATA_HANDLING.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Data handling and visualization
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="chapters/02_data_handling/summarizing_data.html">
            
                
                    <a href="../../chapters/02_data_handling/summarizing_data.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Summarizing data
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="chapters/02_data_handling/format_conversions.html">
            
                
                    <a href="../../chapters/02_data_handling/format_conversions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Data format conversions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="chapters/02_data_handling/visualization.html">
            
                
                    <a href="../../chapters/02_data_handling/visualization.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Visualizing data using ggplot2
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="chapters/03_iteration_procedures/ITERATION_PROCEDURES.html">
            
                
                    <a href="../../chapters/03_iteration_procedures/ITERATION_PROCEDURES.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Iteration procedures
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="chapters/03_iteration_procedures/for_loops.html">
            
                
                    <a href="../../chapters/03_iteration_procedures/for_loops.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        for loops
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="chapters/03_iteration_procedures/apply.html">
            
                
                    <a href="../../chapters/03_iteration_procedures/apply.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        The *apply family
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="chapters/03_iteration_procedures/functional_programming.html">
            
                
                    <a href="../../chapters/03_iteration_procedures/functional_programming.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Functional programming
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="chapters/04_speed_up/SPEED_UP.html">
            
                
                    <a href="../../chapters/04_speed_up/SPEED_UP.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Speeding up iteration procedures
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="chapters/04_speed_up/parallelization.html">
            
                
                    <a href="../../chapters/04_speed_up/parallelization.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Parallelization
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="4.2" data-path="chapters/04_speed_up/rcpp.html">
            
                
                    <a href="../../chapters/04_speed_up/rcpp.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        C++ interconnectivity via Rcpp
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="chapters/05_final_remarks/FINAL_REMARKS.html">
            
                
                    <a href="../../chapters/05_final_remarks/FINAL_REMARKS.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Final remarks
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Advanced Programming in R</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="c-interconnectivity-via-rcpp">C++ interconnectivity via <strong>Rcpp</strong></h1>
<h3 id="prerequisites">Prerequisites</h3>
<p>In order for <strong>Rcpp</strong> to work, we have to make sure your local system is capable 
of building packages. On Linux-based systems, this shouldn&apos;t be much of a 
problem since things just generally tend to work whereas on Windows (or OS X), 
you will possible be required to install 
<a href="https://cran.r-project.org/bin/windows/Rtools/" target="_blank"><strong>Rtools</strong></a> 
(or <a href="https://itunes.apple.com/us/app/xcode/id497799835?mt=12" target="_blank"><strong>Xcode</strong></a>) to be 
able to compile C++ functions and make them available in R. Further information 
on package development prerequisites can be found 
<a href="https://support.rstudio.com/hc/en-us/articles/200486498-Package-Development-Prerequisites" target="_blank">here</a>. </p>
<p>You may easily check if everything works by running the following code chunk.</p>
<pre><code class="lang-r"><span class="hljs-comment">## load &apos;Rcpp&apos; package</span>
<span class="hljs-keyword">library</span>(Rcpp)

<span class="hljs-comment">## try to evaluate c++ expression</span>
evalCpp(<span class="hljs-string">&quot;1 + 1&quot;</span>)
</code></pre>
<pre><code>[1] 2
</code></pre><p>If this expression does <u>not</u> evaluate to &apos;2&apos;, there&apos;s something wrong with 
your local setup and you should possibly contact one of the lecturers for 
troubleshooting.</p>
<h3 id="how-to-make-your-c-code-available-in-r">How to make your C++ code available in R</h3>
<p><strong>Rcpp</strong> offers two ways to import C++ functions into R, namely</p>
<ul>
<li><code>cppFunction</code> and</li>
<li><code>sourceCpp</code>. </li>
</ul>
<p>While the former takes an entire C++ source code as input argument (<code>code</code>), the 
latter behaves very similar to base-R <code>source</code> in the sense that it sources a 
code file (.cpp) and makes the functions included therein available in your<br>global R environment. During this short overview, however, we&apos;ll primarily focus 
on the first approach while the latter is introduced only briefly.</p>
<h5 id="no-input-scalar-output">No input, scalar output</h5>
<p>No matter which approach you will use in the end, <strong>Rcpp</strong> will take the C++ 
code, compile it and transform it into a proper R function. Imagine, for 
instance, the following code (which is heavily based on Hadley Wickham&apos;s 
<a href="http://adv-r.had.co.nz/Rcpp.html" target="_blank">Advanced R. High performance functions with Rcpp</a> 
tutorial). </p>
<pre><code class="lang-r"><span class="hljs-comment">## function that returns &apos;1&apos;</span>
cppFunction(<span class="hljs-string">&apos;int one() {
  return 1;
}&apos;</span>)

one()
</code></pre>
<pre><code>[1] 1
</code></pre><p>Note that C++ requires you to specify the output type of <code>one()</code> which, in this 
particular case, is obviously an integer (<code>int</code>). Accordingly, R variables of 
type &apos;numeric&apos;, &apos;character&apos; and &apos;logical&apos; are referred to as <code>double</code>, <code>String</code> 
and <code>bool</code> in C++ language. Let&apos;s move on to our next example.</p>
<h5 id="scalar-input-scalar-output">Scalar input, scalar output</h5>
<p>When working with C++ code, you are required to not only specify the output 
type of your function, but also the type(s) of the input argument(s). The next 
code chunk defines a function <code>signC</code> that takes an integer input <code>x</code> and, 
depending on the arithmetic sign of <code>x</code>, returns one of &apos;1&apos;, &apos;0&apos; and &apos;-1&apos;. </p>
<pre><code class="lang-r"><span class="hljs-comment">## function that returns 1 if &apos;x&apos; is positive, -1 if &apos;x&apos; is negative, 0 otherwise</span>
cppFunction(<span class="hljs-string">&apos;int signC(int x) {
  if (x &gt; 0) {
    return 1;
  } else if (x == 0) {
    return 0;
  } else {
    return -1;
  }
}&apos;</span>)

signC(-<span class="hljs-number">10</span>)
</code></pre>
<pre><code>[1] -1
</code></pre><p>Note also that <code>if</code> statements in C++ look very similar to their R equivalent. 
The only obvious differences are </p>
<ul>
<li>the need to explicitly include a <code>return</code> statement and </li>
<li>the semicolons (<code>;</code>) terminating each line of code.</li>
</ul>
<h5 id="vector-input-scalar-output">Vector input, scalar output</h5>
<p>Although this seems hardly necessary, let&apos;s assume for now that we wanted to 
rewrite the base-R <code>sum</code> function in C++. Rather than supplying a scalar input 
argument, we need the function to work with a vector of numbers for obvious 
reasons. Similar to the different scalar inputs depicted above, base-R 
&apos;integer&apos;, &apos;numeric&apos;, &apos;character&apos; and &apos;logical&apos; vectors are represented as 
<code>IntegerVector</code>, <code>NumericVector</code>, <code>CharacterVector</code> and <code>LogicalVector</code> in C++. 
This time, it also makes sense to define the input type as <code>NumericVector</code> and, 
accordingly, the output type as <code>double</code> since we&apos;d possibly like to supply 
numbers with decimal places instead of raw integers.</p>
<pre><code class="lang-r">cppFunction(<span class="hljs-string">&apos;double sumC(NumericVector x) {
  int n = x.size();
  double total = 0;
  for(int i = 0; i &lt; n; ++i) {
    total += x[i];
  }
  return total;
}&apos;</span>)

sumC(seq(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>))
</code></pre>
<pre><code>[1] 5.5
</code></pre><h5 id="matrix-input-vector-output">Matrix input, vector output</h5>
<p><strong>Rcpp</strong> also comes with a number of so-called &apos;sugars&apos; that help newcomers to 
find their way by providing C++-equivalents of a number of built-in R functions. 
A short overview of featured functions is e.g. given by 
Fran&#xE7;ois and Eddelbuettel (2015). Amongst others, these include </p>
<ul>
<li><strong>math functions</strong>, e.g. <code>abs</code>, <code>ceiling</code>, <code>floor</code>, <code>exp</code>, <code>log</code></li>
<li><strong>scalar summaries</strong>, e.g. <code>mean</code>, <code>min</code>, <code>max</code>, <code>sum</code>, <code>sd</code>, <code>var</code></li>
<li><strong>vector summaries</strong>, e.g. <code>cumsum</code>, <code>diff</code></li>
<li><strong>finding utilities</strong>, e.g. <code>which_max</code>, <code>which_min</code>, <code>match</code></li>
<li><strong>finding duplicates</strong>, e.g. <code>duplicated</code>, <code>unique</code></li>
</ul>
<p>In order to demonstrate the proper use of such &apos;sugars&apos; and, at the same time, 
introduce <code>NumericMatrix</code> (<code>NumericVector</code>) as further input (output) variable 
types, let&apos;s replicate the previous example on the use of <code>apply</code> to calculate 
mean values from each single variable column of the &apos;diamonds&apos; dataset using 
<strong>Rcpp</strong> functionality. For the sake of simplicity of this demonstration, let&apos;s 
again focus on the numeric columns only (note also the use of <code>sapply</code> to create 
an index vector of (non-)numeric columns). </p>
<pre><code class="lang-r"><span class="hljs-comment">## subset with numeric columns only</span>
num_cols &lt;- sapply(<span class="hljs-number">1</span>:ncol(diamonds), <span class="hljs-keyword">function</span>(i) is.numeric(diamonds[, i]))
diamonds_sub &lt;- as.matrix(diamonds[, num_cols])

<span class="hljs-comment">## c++-version of &apos;colMeans&apos;</span>
cppFunction(<span class="hljs-string">&quot;NumericVector colMeansC(NumericMatrix x) {

  // number of rows and columns
  int nCol = x.ncol();
  int nRow = x.nrow();

  // temporary variable of size nrow(x) to store column values in
  NumericVector nVal(nRow);

  // initialize output vector
  NumericVector out(nCol);

  // loop over each column
  for (int i = 0; i &lt; nCol; i++) {

    // values in current column
    nVal = x(_, i);

    // store mean of current &apos;nVal&apos; in &apos;out[i]&apos;
    out[i] = mean(nVal);
  }

  return out;
}&quot;</span>)

means &lt;- colMeansC(diamonds_sub)
names(means) &lt;- colnames(diamonds_sub)
means
</code></pre>
<pre><code>numeric(0)
</code></pre><pre><code class="lang-r"><span class="hljs-comment">## speed check</span>
microbenchmark(
  val_apply &lt;- apply(diamonds_sub, <span class="hljs-number">2</span>, mean), 
  val_cpp &lt;- colMeansC(diamonds_sub)
, times = <span class="hljs-number">20L</span>)
</code></pre>
<pre><code>Unit: microseconds
                                      expr      min       lq      mean   median       uq      max neval cld
 val_apply &lt;- apply(diamonds_sub, 2, mean) 1094.562 1109.860 1157.9485 1116.984 1183.910 1469.513    20   b
        val_cpp &lt;- colMeansC(diamonds_sub)   53.401   91.378   95.5936   97.382  103.882  118.056    20  a
</code></pre><pre><code class="lang-r"><span class="hljs-comment">## similarity check</span>
identical(val_apply, means)
</code></pre>
<pre><code>[1] TRUE
</code></pre><p>It&apos;s milliseconds we are talking about here, but still - <code>colMeansC</code> runs 
more than 5 times faster as compared to the <code>apply</code> approach!</p>
<h3 id="what-s-the-point-of-that">What&apos;s the point of that?</h3>
<p>You might guess that we did not decide to include this chapter on C++ 
interconnectivity just for fun. The actual reason is that C++ code performs much 
faster as compared to R when it comes to <code>for</code> loops. Without going too much 
into detail, one of the underlying reason is the very efficient memory 
management of the C++ language as compared to the massive overhead that R 
produces during each intermediary step. But find out for yourselves...</p>
<h5 id="task-1-sumr-vs-sumc">Task 1: <code>sumR</code> vs. <code>sumC</code></h5>
<p>Write a function <code>sumR</code> (do <u>not</u> use the built-in <code>sum</code> function) as an 
equivalent to the above <code>sumC</code> function and have a look at the time it takes to 
run <code>sumR(1:1e6)</code> using <code>system.time</code> (or <code>microbenchmark</code>). </p>
<center>
  <img src="https://pixabay.com/static/uploads/photo/2012/04/14/14/04/hourglass-34048_640.png" alt="hourglass" style="width: 200px;">
</center>




<pre><code class="lang-r"><span class="hljs-comment">## speed check</span>
microbenchmark(
  sum(<span class="hljs-number">1</span>:<span class="hljs-number">1e6</span>), <span class="hljs-comment"># built-in `sum` function</span>
  sumR(<span class="hljs-number">1</span>:<span class="hljs-number">1e6</span>), <span class="hljs-comment"># base-R version</span>
  sumC(<span class="hljs-number">1</span>:<span class="hljs-number">1e6</span>)  <span class="hljs-comment"># rcpp version</span>
, times = <span class="hljs-number">20L</span>)
</code></pre>
<pre><code>Unit: milliseconds
          expr        min         lq       mean     median         uq        max neval cld
  sum(1:1e+06)   1.840383   1.883224   2.435301   1.923645   2.608507   4.349734    20  a 
 sumR(1:1e+06) 533.454175 542.007388 587.183130 550.033199 644.815133 759.895094    20   b
 sumC(1:1e+06)   3.054200   3.116862   4.049178   3.577073   4.441693   8.095296    20  a
</code></pre><p>As you can see, <code>sumC</code> runs more than 40 times faster than <code>sumR</code> and, at the 
same time, performs only slightly slower as compared to the highly optimized 
(vectorized) built-in <code>sum</code> function. You cannot imagine what&apos;s possible with 
<strong>Rcpp</strong> when it comes to more complex operations!</p>
<h3 id="a-short-note-on-the-use-of-sourcecpp">A short note on the use of <code>sourceCpp</code></h3>
<p>For such short operations, the use of <code>cppFunction</code> seems reasonable. However, 
we recommend to use <code>sourceCpp</code> when it comes to more complex C++ functions. 
Take, for example, the following peace of C++ code that reproduces the built-in 
<code>cor</code> function. </p>
<pre><code class="lang-r">cppFunction(<span class="hljs-string">&apos;double corC(NumericVector x, NumericVector y) {
  int nx = x.size(), ny = y.size();

  if (nx != ny) stop(&quot;Input vectors must have equal length!&quot;);

  double sum_x = sum(x), sum_y = sum(y);

  NumericVector xy = x * y;
  NumericVector x_squ = x * x, y_squ = y * y;

  double sum_xy = sum(xy);
  double sum_x_squ = sum(x_squ), sum_y_squ = sum(y_squ);

  double out = ((nx * sum_xy) - (sum_x * sum_y)) / sqrt((nx * sum_x_squ - pow(sum_x, 2.0)) * (nx * sum_y_squ - pow(sum_y, 2.0)));

  return out;
}&apos;</span>)
</code></pre>
<p>Quite confusing, isn&apos;t it? Not the least because the inline C++ is not formatted 
properly. Luckily, RStudio comes with a C++ editor that allows you to write 
stand-alone .cpp functions - including code formatting! For that purpose, 
select &apos;C++ file&apos; from the top-left dropdown menu and paste the code that we 
initially passed as <code>code</code> argument to <code>cppFunction</code>. </p>
<center>
  <img src="http://i.imgur.com/nKf0QZH.png" alt="new_cpp" style="width: 200px;">
</center>

<p>In order to ensure compatibility with <strong>Rcpp</strong> and make the C++ function 
available in R, we need to add a header to our .cpp file (see below). In the 
end, our .cpp file should look as follows.</p>
<pre><code class="lang-cpp"><span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Rcpp.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> Rcpp;

<span class="hljs-comment">// [[Rcpp::export]]</span>
<span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">corC</span><span class="hljs-params">(NumericVector x, NumericVector y)</span> </span>{
  <span class="hljs-keyword">int</span> nx = x.size(), ny = y.size();

  <span class="hljs-keyword">if</span> (nx != ny) stop(<span class="hljs-string">&quot;Input vectors must have equal length!&quot;</span>);

  <span class="hljs-keyword">double</span> sum_x = sum(x), sum_y = sum(y);

  NumericVector xy = x * y;
  NumericVector x_squ = x * x, y_squ = y * y;

  <span class="hljs-keyword">double</span> sum_xy = sum(xy);
  <span class="hljs-keyword">double</span> sum_x_squ = sum(x_squ), sum_y_squ = sum(y_squ);

  <span class="hljs-keyword">double</span> out = ((nx * sum_xy) - (sum_x * sum_y)) / <span class="hljs-built_in">sqrt</span>((nx * sum_x_squ - <span class="hljs-built_in">pow</span>(sum_x, <span class="hljs-number">2.0</span>)) * (nx * sum_y_squ - <span class="hljs-built_in">pow</span>(sum_y, <span class="hljs-number">2.0</span>)));

  <span class="hljs-keyword">return</span> out;
}
</code></pre>
<p>Save the file in &apos;src/corC.cpp&apos; and return to R, then run</p>
<pre><code class="lang-r"><span class="hljs-comment">## source &apos;corC&apos; function (remember to adjust the path)</span>
sourceCpp(<span class="hljs-string">&quot;../../../src/corC.cpp&quot;</span>)

<span class="hljs-comment">## correlation of &apos;carat&apos; and &apos;price&apos;  </span>
microbenchmark(
  cor(diamonds$carat, diamonds$price), 
  corC(diamonds$carat, diamonds$price) 
, times = <span class="hljs-number">20L</span>)
</code></pre>
<pre><code>Unit: microseconds
                                 expr     min        lq     mean   median       uq      max neval cld
  cor(diamonds$carat, diamonds$price) 837.035  900.3845 1015.371 1001.847 1089.547 1317.683    20  a 
 corC(diamonds$carat, diamonds$price) 988.046 1028.1385 1394.055 1105.118 1516.771 4284.448    20   b
</code></pre><p>Note that, again, <code>corC</code> performs only slightly slower than the built-in <code>cor</code> 
function. Just imagine the speed gain as compared to a possible <code>corR</code> function!</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../chapters/04_speed_up/parallelization.html" class="navigation navigation-prev " aria-label="Previous page: Parallelization"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../chapters/05_final_remarks/FINAL_REMARKS.html" class="navigation navigation-next " aria-label="Next page: Final remarks"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
