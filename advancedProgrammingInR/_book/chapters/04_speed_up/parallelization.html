<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Parallelization | Advanced Programming in R</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.4.0">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../chapters/04_speed_up/rcpp.html" />
    
    
    <link rel="prev" href="../../chapters/04_speed_up/SPEED_UP.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="4.1" data-basepath="../.." data-revision="Thu Oct 08 2015 09:33:45 GMT+0200 (CEST)">
    

<div class="book-summary">
    <div class="book-search" role="search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="chapters/01_structured_workflow/STRUCTURED_WORKFLOW.html">
            
                
                    <a href="../../chapters/01_structured_workflow/STRUCTURED_WORKFLOW.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Towards a structured workflow
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="chapters/01_structured_workflow/projects.html">
            
                
                    <a href="../../chapters/01_structured_workflow/projects.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        RStudio projects
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="chapters/01_structured_workflow/version_control.html">
            
                
                    <a href="../../chapters/01_structured_workflow/version_control.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        GitHub version control
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="chapters/02_data_handling/DATA_HANDLING.html">
            
                
                    <a href="../../chapters/02_data_handling/DATA_HANDLING.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Data handling and visualization
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="chapters/02_data_handling/summarizing_data.html">
            
                
                    <a href="../../chapters/02_data_handling/summarizing_data.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Summarizing data
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="chapters/02_data_handling/format_conversions.html">
            
                
                    <a href="../../chapters/02_data_handling/format_conversions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Data format conversions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="chapters/02_data_handling/visualization.html">
            
                
                    <a href="../../chapters/02_data_handling/visualization.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Visualizing data using ggplot2
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="chapters/03_iteration_procedures/ITERATION_PROCEDURES.html">
            
                
                    <a href="../../chapters/03_iteration_procedures/ITERATION_PROCEDURES.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Iteration procedures
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="chapters/03_iteration_procedures/for_loops.html">
            
                
                    <a href="../../chapters/03_iteration_procedures/for_loops.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        for loops
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="chapters/03_iteration_procedures/apply.html">
            
                
                    <a href="../../chapters/03_iteration_procedures/apply.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        The *apply family
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="chapters/03_iteration_procedures/functional_programming.html">
            
                
                    <a href="../../chapters/03_iteration_procedures/functional_programming.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Functional programming
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="chapters/04_speed_up/SPEED_UP.html">
            
                
                    <a href="../../chapters/04_speed_up/SPEED_UP.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Speeding up iteration procedures
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="4.1" data-path="chapters/04_speed_up/parallelization.html">
            
                
                    <a href="../../chapters/04_speed_up/parallelization.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Parallelization
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="chapters/04_speed_up/rcpp.html">
            
                
                    <a href="../../chapters/04_speed_up/rcpp.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        C++ interconnectivity via Rcpp
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="chapters/05_final_remarks/FINAL_REMARKS.html">
            
                
                    <a href="../../chapters/05_final_remarks/FINAL_REMARKS.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Final remarks
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Advanced Programming in R</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="parallelization">Parallelization</h1>
<p>As regards multi-core operations, there&apos;s actually a whole bunch of packages 
that allow you to distribute particular processing steps to multiple cores on 
your local machine. Out of those, we decided to focus on <strong>doParallel</strong> (in 
conjunction with <strong>foreach</strong>) as it represents a straightforward solution that 
does not require the user to manually export objects from the global environment 
to the single nodes (e.g. required by <code>par*apply</code> along with <strong>parallel</strong>).</p>
<h3 id="getting-started">Getting started</h3>
<p>Let&apos;s start straight away with detecting the number of cores available on your 
machine via <code>detectCores</code>. In the end, there&apos;s no use in trying to split a 
certain task into 5 parts when there are only 4 horses available, is it? &#x1F609; </p>
<pre><code class="lang-r"><span class="hljs-comment">## load &apos;doParallel&apos; package</span>
<span class="hljs-keyword">library</span>(doParallel)

<span class="hljs-comment">## no. of local cores</span>
detectCores()
</code></pre>
<pre><code>[1] 4
</code></pre><p>In our case, there are 4 nodes available for parallelization among which 
iteration procedures may be divided. Note that this number typically varies 
between computers. Note also that <code>library(doParallel)</code> automatically attaches 
the <strong>foreach</strong> package which we will require later on, so there&apos;s no need to 
manually load it. In fact, this would only be required if we decided to use 
<code>foreach</code> on a single core, but for such operations, we highly recommend to use 
<code>*apply</code>.</p>
<p>Next, let&apos;s create a socket cluster for parallel processing via <code>makeCluster</code>. 
Think of this as a set of workers among which a particular work step should be 
divided equally - just like in the image on the previous page. With 
<code>registerDoParallel</code>, we tell R that it should use the cluster &apos;cl&apos; for any 
further multi-core operations performed with <code>foreach</code>.</p>
<pre><code class="lang-r"><span class="hljs-comment">## create parallel socket cluster</span>
cl &lt;- makeCluster(<span class="hljs-number">3</span>)

<span class="hljs-comment">## register parallel backend</span>
registerDoParallel(cl)
</code></pre>
<p>You will probably notice that we told R to use 3 nodes to work with. Why not use<br>all 4 nodes?, you might wonder. Well, parallel processing distributed among all 
nodes available tends to slow down your computer considerably. Since we&apos;d 
possibly like to perform some other actions while R is occupied (e.g. browsing 
the internet, checking e-mails, etc.), it is wise to leave some remaining 
computational power for such operations as well.  </p>
<h3 id="the-foreach-syntax">The <code>foreach</code> syntax</h3>
<p>Now that we&apos;re set up properly, it&apos;s time to give our cluster something to work 
with. Remember the previous example on calculating the linear relationship 
between &apos;carat&apos; and &apos;price&apos; for each &apos;cut&apos; quality iteratively? We&apos;re gonna do the same thing again now 
except this time it&apos;s <code>foreach</code> we&apos;ll be working with. Similar to <code>*apply</code>, 
<code>foreach</code> requires a set of input data and a function to perform on the very same. 
Have a look at the following example. </p>
<pre><code class="lang-r"><span class="hljs-comment">## calculate square root, return list</span>
foreach(i = <span class="hljs-number">1</span>:<span class="hljs-number">4</span>) %do% sqrt(i)
</code></pre>
<pre><code>[[1]]
[1] 1

[[2]]
[1] 1.414214

[[3]]
[1] 1.732051

[[4]]
[1] 2
</code></pre><p>Similar to <code>lapply</code>, <code>foreach</code> returns an object of class &apos;list&apos; by default. The 
function body, by contrast, is connected with the part on variable 
definition via the binary operator <code>%do%</code>. This might seem odd at first, but you 
will notice later on that this syntax comes in quite handy when forwarding 
<code>foreach</code>-related operations to a parallel cluster. </p>
<p>We may easily change the output type of <code>foreach</code> by telling R how to <code>.combine</code> 
the results of the single iterations via </p>
<pre><code class="lang-r"><span class="hljs-comment">## calculate sqare root, return vector</span>
foreach(i = <span class="hljs-number">1</span>:<span class="hljs-number">4</span>, .combine = <span class="hljs-string">&quot;c&quot;</span>) %do% sqrt(i)
</code></pre>
<pre><code>[1] 1.000000 1.414214 1.732051 2.000000
</code></pre><p>et voil&#xE0;, we transformed the <code>lapply</code>-style list output of our loop into an 
<code>sapply</code>-style vector output.  </p>
<p>Let&apos;s now come back to the &apos;diamonds&apos; dataset. Since you may just take the 
function body from the previous application with <code>lapply</code>, it&apos;s up to you to 
calculate the linear model between &apos;carat&apos; and &apos;price&apos; for each group of &apos;cut&apos;. 
Remember to <code>split</code> the &apos;diamonds&apos; dataset first and pass the thus created list 
(with each list entry representing a group of uniform cuts) to <code>foreach</code>.</p>
<center>
  <img src="https://pixabay.com/static/uploads/photo/2012/04/14/14/04/hourglass-34048_640.png" alt="hourglass" style="width: 200px;">
</center>



<h3 id="how-not-to-use-parallel-features">How <em>not</em> to use parallel features</h3>
<p>Let&apos;s see how long this code chunk takes to perform. The <strong>microbenchmark</strong> 
package is just the right thing for such an operation.</p>
<pre><code class="lang-r"><span class="hljs-comment">## load &apos;microbenchmark&apos; package</span>
<span class="hljs-keyword">library</span>(microbenchmark)

<span class="hljs-comment">## load &apos;ggplot2&apos; and split &apos;diamonds&apos; dataset</span>
<span class="hljs-keyword">library</span>(ggplot2)
ls_diamonds &lt;- split(diamonds, f = diamonds$cut)

<span class="hljs-comment">## speed test (this might take some time)</span>
microbenchmark({
  foreach(i = ls_diamonds) %do% lm(carat ~ price, data = i)
}, times = <span class="hljs-number">20L</span>) <span class="hljs-comment"># number of times to evaluate the expression</span>
</code></pre>
<pre><code>Unit: milliseconds
                                                              expr      min       lq     mean
 {     foreach(i = ls_diamonds) %do% lm(carat ~ price, data = i) } 46.95132 49.71469 50.99942
   median       uq      max neval
 51.81826 52.22522 53.89055    20
</code></pre><p>Hm, quite some time. Let&apos;s see how long it takes on when using multiple cores. 
The only thing that&apos;s required in order to let this operation run on multiple 
cores is to replace <code>%do%</code> with <code>%dopar%</code>. In doing so (and distributing the 
iterative <code>lm</code> calculation on multiple cores), the operation should perform 
much faster, right?</p>
<pre><code class="lang-r">microbenchmark({
  foreach(i = ls_diamonds) %dopar% lm(carat ~ price, data = i)
}, times = <span class="hljs-number">20L</span>)
</code></pre>
<pre><code>Unit: milliseconds
                                                                 expr      min       lq     mean
 {     foreach(i = ls_diamonds) %dopar% lm(carat ~ price, data = i) } 176.5104 207.1189 276.6854
   median       uq      max neval
 219.3691 231.4421 1374.321    20
</code></pre><p>Oops, what&apos;s going on now? Obviously, this action doesn&apos;t perform faster at all 
although we told R to run in parallel via <code>%dopar%</code>. In fact, this is a bad 
example for the parallelized use of <code>foreach</code>. <code>lm</code> is a highly optimized base-R 
function that performs quite fast without the need to go parallel. &quot;With [such] 
small tasks, the overhead of scheduling the task and returning the result can be 
greater than the time to execute the task itself, resulting in poor 
performance.&quot; (Weston and Calaway, 2014)</p>
<h3 id="how-to-use-parallel-features">How to use parallel features</h3>
<p>Now that you&apos;ve learned how <em>not</em> to use <code>%dopar%</code>, let&apos;s see what a proper use 
would look like. &apos;Proper&apos; in this prospect refers to a piece of code that is 
computationally expensive and needs to be repeated at least a couple of times. 
For example, let&apos;s assume we wanted to separately predict &apos;cut&apos;, &apos;color&apos; and 
&apos;carat&apos; for each specimen from &apos;diamonds&apos; based on all remaining variables. 
Using <code>foreach</code> (or <code>lapply</code>), the referring code would roughly look as follows.</p>
<pre><code class="lang-r"><span class="hljs-comment">## load &apos;party&apos; package</span>
<span class="hljs-keyword">library</span>(party)

system.time({

  <span class="hljs-comment">## conditional inference trees </span>
  ls_ct &lt;- foreach(i = c(<span class="hljs-string">&quot;cut&quot;</span>, <span class="hljs-string">&quot;color&quot;</span>, <span class="hljs-string">&quot;carat&quot;</span>)) %do% {

    <span class="hljs-comment"># formula</span>
    frml &lt;- as.formula(paste(i, <span class="hljs-string">&quot;.&quot;</span>, sep = <span class="hljs-string">&quot; ~ &quot;</span>))

    <span class="hljs-comment"># classification</span>
    ctree(frml, data = diamonds,
          controls = ctree_control(testtype = <span class="hljs-string">&quot;MonteCarlo&quot;</span>,
                                   nresample = <span class="hljs-number">999</span>,
                                   mincriterion = <span class="hljs-number">0.999</span>,
                                   maxdepth = <span class="hljs-number">3</span>))
  }
})
</code></pre>
<p><code>ctree</code> performs rather slowly, which is particularly owing to <code>nresample</code> that 
tells the function to perform 1000 internal Monte-Carlo replications. Luckily, 
we can easily split this operation into 3 parts, i.e. one node takes &apos;cut&apos; as 
response variable, another node &apos;color&apos; and a third node &apos;carat&apos; - at the same 
time!</p>
<pre><code class="lang-r">system.time({

  <span class="hljs-comment">## conditional inference trees </span>
  ls_ct &lt;- foreach(i = c(<span class="hljs-string">&quot;cut&quot;</span>, <span class="hljs-string">&quot;color&quot;</span>, <span class="hljs-string">&quot;carat&quot;</span>), 
                   .packages = c(<span class="hljs-string">&quot;ggplot2&quot;</span>, <span class="hljs-string">&quot;party&quot;</span>)) %dopar% {

    <span class="hljs-comment"># formula</span>
    frml &lt;- as.formula(paste(i, <span class="hljs-string">&quot;.&quot;</span>, sep = <span class="hljs-string">&quot; ~ &quot;</span>))

    <span class="hljs-comment"># classification</span>
    ctree(frml, data = diamonds,
          controls = ctree_control(testtype = <span class="hljs-string">&quot;MonteCarlo&quot;</span>,
                                   nresample = <span class="hljs-number">999</span>,
                                   mincriterion = <span class="hljs-number">0.999</span>,
                                   maxdepth = <span class="hljs-number">3</span>))
  }
})
</code></pre>
<p>Of course, this is seconds we are talking about. Nonetheless, everyone of you 
will eventually end up with quite big datasets upon which computationally 
expensive operations need to be performed in an iterative manner. It might be 
hours or even days (trust us, we know what we&apos;re talking about...) that one 
single operation takes to perform - and then, the <code>%dopar%</code> might come in quite 
handy.</p>
<h3 id="closing-a-parallel-backend">Closing a parallel backend</h3>
<p>One final remark on the proper use of parallel backends in R. When working on 
multiple cores, you can easily lose track of how many parallel backends, if any, 
you registered during your current session, especially when some error prevents 
your script from finishing. If you should ever find yourself in such a 
situation, do not hesitate to use <code>showConnections</code> to print information on 
currently open connections to the R console. </p>
<pre><code class="lang-r">showConnections()
</code></pre>
<pre><code>  description         class            mode  text     isopen   can read can write
4 &quot;output&quot;            &quot;textConnection&quot; &quot;wr&quot;  &quot;text&quot;   &quot;opened&quot; &quot;no&quot;     &quot;yes&quot;    
5 &quot;&lt;-localhost:11736&quot; &quot;sockconn&quot;       &quot;a+b&quot; &quot;binary&quot; &quot;opened&quot; &quot;yes&quot;    &quot;yes&quot;    
6 &quot;&lt;-localhost:11736&quot; &quot;sockconn&quot;       &quot;a+b&quot; &quot;binary&quot; &quot;opened&quot; &quot;yes&quot;    &quot;yes&quot;    
7 &quot;&lt;-localhost:11736&quot; &quot;sockconn&quot;       &quot;a+b&quot; &quot;binary&quot; &quot;opened&quot; &quot;yes&quot;    &quot;yes&quot;
</code></pre><p>There&apos;s 3 socket connections (i.e. cores) registered at the moment, just as we 
initially defined via <code>registerDoParallel</code>. In order to close these connections 
(which we recommend to consider at the end of each parallelized R script), 
simply perform </p>
<pre><code class="lang-r">stopImplicitCluster()
</code></pre>
<p>which explicitly deregisters the implicitly created cluster.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../chapters/04_speed_up/SPEED_UP.html" class="navigation navigation-prev " aria-label="Previous page: Speeding up iteration procedures"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../chapters/04_speed_up/rcpp.html" class="navigation navigation-next " aria-label="Next page: C++ interconnectivity via Rcpp"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
